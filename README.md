# terraform-aws-pablosspot-lb

This Terraform module provisions an AWS Load Balancer (Application or Network) with HTTPS and HTTP->HTTPS redirect listeners, a dedicated security group, optional ingress/egress rules, optional access logging, and an optional Route 53 alias record.

The module intentionally creates listeners but does not attach backend target groups. This keeps the module focused on LB/SSL/DNS provisioning while allowing you to manage target groups and routing policies separately.

A compact autogenerated summary of inputs, outputs, resources and providers is available in `terraform-docs.md` in this repository.

---

## Features

- Create an `aws_lb` (ALB by default) with a name derived from `environment_name` and workspace.
- Create an `aws_security_group` for the LB and attach any additional security group IDs you pass.
- Conditional access logging to an S3 bucket.
- Create ingress rules for TLS (443) and egress rules (all traffic) based on provided CIDR lists.
- HTTPS listener (443) with a default fixed 401 JSON response. (This module does not create any target groups.)
- HTTP listener (80) that redirects to HTTPS (301).
- Conditional Route 53 `A` alias record pointing at the LB when `endpoint.aws_dns = true`.
- Provider default tags applied to all resources.

---

## Quick summary

- LB name: `${var.environment_name}-${terraform.workspace}-lb`
- HTTPS listener: port 443, requires `certificate_arn`, default action returns 401 (fixed-response)
- HTTP listener: port 80, redirects to HTTPS (301)
- Subnets: discovered via `data.aws_subnets` using `vpc_id` and tag `role = public` (or `private` for internal LBs)
- Route 53: created only when `endpoint.aws_dns` is truthy

---

## Files of interest

- Main resources and listeners: [main.tf](./main.tf) (Ingress/egress rules, listeners, Route53 record also present)
- Variables / inputs: [variables.tf](./variables.tf) (module input variables)
  - region, environment_name, vpc_id, internal, load_balancer_type, ssl_policy
  - endpoint (object with value/base_domain/aws_dns), idle_timeout
  - access_log_bucket, security_group_ids, certificate_arn
  - ingress_cidr_ipv4_list, ingress_cidr_ipv6_list
  - egress_cidr_ipv4_list, egress_cidr_ipv6_list
- Data sources: [data.tf](./data.tf) (Data references for pre-existing resources)
- Outputs: [outputs.tf](./outputs.tf) (module output)

---

## Inputs (important ones)

For the complete autogenerated input table, see `terraform-docs.md`. Below are the most important inputs:

- `environment_name` (string, required) — Base name for the LB and SG.
- `vpc_id` (string, required) — VPC to search for subnets.
- `endpoint` (object, required) — Values used for Route 53 record creation:
  - `value` (string) — host/name portion (e.g., `app` for `app.example.com`).
  - `base_domain` (string) — zone domain (e.g., `example.com`).
  - `aws_dns` (optional bool) — set to `true` to enable creation of Route 53 record.
- `certificate_arn` (string, required) — ACM certificate ARN used by the HTTPS listener.
- `security_group_ids` (list(string), optional) — additional existing SGs to attach to LB.
- `access_log_bucket` (string, optional) — S3 bucket name for ALB access logs. When set, access logging is enabled with prefix `elblogs-${var.environment_name}-lb-${terraform.workspace}`.
- `ingress_cidr_ipv4_list` / `ingress_cidr_ipv6_list` (list(string), optional) — CIDRs to allow on port 443 (TLS).
- `egress_cidr_ipv4_list` / `egress_cidr_ipv6_list` (list(string), optional) — CIDRs for egress rules (protocol `-1` by default).
- `internal` (bool, default false) — use private subnets & create internal LB when true.
- `load_balancer_type` (string, default `application`) — ALB vs NLB.
- `ssl_policy` (string, default `ELBSecurityPolicy-TLS13-1-2-2021-06`) — SSL policy for HTTPS listener.
- `idle_timeout` (number, default 60) — LB idle timeout (seconds).

---

## Outputs

- `lb_dns` — DNS name of the created load balancer (useful for DNS records or health checks).
- `lb_listener_arn` — ARN of the HTTPS listener (443), useful to attach listener rules or listener actions externally.
- `security_group_id` — ID of the load balancer security group created by the module (`aws_security_group.lb_sg`).
- `lb_arn` — ARN of the created load balancer (`aws_lb.lb`).
- `subnet_ids` — List of subnet ids selected for the load balancer (from `data.aws_subnets.subnets.ids`).


---

## Example usage

This module purposefully does not create target groups. Typical usage is to create the LB with this module, then separately create a target group and attach listener rules.

```/dev/null/usage_example.tf#L1-200
module "lb" {
  source           = "./terraform-aws-pablosspot-lb"
  environment_name = "prod"
  vpc_id           = "vpc-0123456789abcdef0"
  endpoint = {
    value       = "myapp"
    base_domain = "example.com"
    aws_dns     = true
  }
  certificate_arn        = "arn:aws:acm:ap-southeast-2:123456789012:certificate/abcd-ef01-2345-6789"
  ingress_cidr_ipv4_list = ["0.0.0.0/0"]
  access_log_bucket      = "my-alb-logs-bucket"
}

# Create target group and attach a listener rule that forwards traffic to it:
resource "aws_lb_target_group" "tg" {
  name        = "prod-myapp-tg"
  port        = 80
  protocol    = "HTTP"
  vpc_id      = var.vpc_id # pass your VPC ID from the root module
  target_type = "ip"
}

resource "aws_lb_listener_rule" "forward" {
  listener_arn = module.lb.lb_listener_arn
  priority     = 100

  action {
    type             = "forward"
    target_group_arn = aws_lb_target_group.tg.arn
  }

  condition {
    path_pattern {
      values = ["/*"]
    }
  }
}
```

Note: The usage example references `module.lb.lb_listener_arn` and `module.lb.lb_dns`. If you prefer additional outputs (like `security_group_id` or `subnets`), the module can be extended to expose those.

---

## Implementation notes & caveats

- Subnet discovery uses `data.aws_subnets` and filters tags by `role = public` when `internal = false`, or `role = private` when `internal = true`. Make sure your subnets are tagged accordingly.
- The HTTPS listener's default action is a fixed `401` (JSON "Unauthorised"). This is deliberate so that the module does not assume how you want to route traffic. You must create target groups and listener rules to forward traffic to backends.
- Route 53 record creation is conditional: the module checks `try(var.endpoint.aws_dns, false)`. If `aws_dns` is omitted or false, no Route 53 record is created.
- Security group rules are created per-entry from the provided CIDR lists. If you want open access, include `0.0.0.0/0` explicitly in `ingress_cidr_ipv4_list`.
- Access logging prefix: `elblogs-${var.environment_name}-lb-${terraform.workspace}` when `access_log_bucket` is provided.
- The module sets `default_tags` on the AWS provider, so all resources receive tags: `managed_by=terraform`, `module_created=true`, `module_name=terraform-aws-pablosspot-lb`.
- `tfsec` ignore: there is an ignore at top of `main.tf` for `aws-elb-alb-not-public`. Ensure you evaluate the risk if creating public-facing ALBs.
